/** 
 * @fileoverview This file work with product basket (cart)
 * @author Igor Zhabskiy <Igor.Zhabskiy.@gmail.com>
 * @version 0.1
 */
function m_cart_delivery_price() {
    var inputs = document.getElementsByTagName('input');
    var delivery_type = '';
    var delivery_price = document.getElementById('delivery_price');
    var delivery_city = document.getElementById('delivery_city');
    var delivery_rate = document.getElementById('delivery_rate');
    var region_km = document.getElementById('region_km').value;
    var total_price_clean = document.getElementById('total_price_clean');
    var total_price = document.getElementById('total_price');
    if (region_km == '') {
		region_km = 0;
    } else {
		region_km = +region_km;	
    }
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].type === 'radio' && inputs[i].checked) { delivery_type = inputs[i].value }
    }
    switch (delivery_type) {
        case 'self':
            delivery_price.innerHTML = '0 руб';
            total_price.innerHTML = (+total_price_clean.value + 0) + ' руб'
            break;
        case 'moscow':
            //delivery_price.innerHTML = delivery_city.value + ' руб';
            delivery_price.innerHTML = '500 руб';
            total_price.innerHTML = (+total_price_clean.value + (+500)) + ' руб'
            break;
        case 'region':
            
			//Hide error block
			hideErrorBlock();

			//Conditions for our km. 
			delivery_rate.value = 0;
			
			/**
			 * Count km
			 */
			/** от 0 до 140 - 35 руб./1 км.
            if (region_km > 0 && region_km <= 30) {
				delivery_rate.value = 0;
				delivery_price.innerHTML = (+delivery_rate.value) + ' руб';
				total_price.innerHTML = (+total_price_clean.value + (+delivery_rate.value)) + ' руб';
            } else if (region_km > 30 && region_km <= 140) {
            	
            	var rs = region_km-30;
				delivery_rate.value = rs*35;
				delivery_price.innerHTML = (+delivery_rate.value) + ' руб';
				total_price.innerHTML = (+total_price_clean.value + (+delivery_city.value) + (+delivery_rate.value)) + ' руб';
			 **/
			if (region_km > 0 && region_km <= 9999) {
				var rs = region_km;
				delivery_rate.value = (rs*30)+500;
				delivery_price.innerHTML = (+delivery_rate.value) + ' руб';
				total_price.innerHTML = (+total_price_clean.value + (+delivery_city.value) + (+delivery_rate.value)) + ' руб';
            } else if (region_km > 9999) {
            	/**
            	 * Show error
            	 */
				var region_km_max = "Доставка превышает 140 км.<br>Связывайтесь с нашими менеджерами и мы отправим Вашу теплицу дешевле транспортной компанией ПЭК.";
				showErrorBlock(region_km_max);
				delivery_price.innerHTML = 0 + ' руб';
				total_price.innerHTML = (+total_price_clean.value)  + ' руб';
				$('html,body').animate({
				   scrollTop: $("#error_all_input").offset().top-50
				});
				return false;
            } else {
				delivery_price.innerHTML = 0 + ' руб';
				total_price.innerHTML = (+total_price_clean.value)  + ' руб';
				return false;
            }
			break;
        default:
            delivery_price.innerHTML = '0 руб';
            total_price.innerHTML = (+total_price_clean.value + 0) + ' руб';
            break;
    }
}

/**
 * This funciton add product to cart
 */

function getGoogleCID() {
	var tracker = ga.getAll()[0];
	var client_id = tracker.get('clientId');
	return (client_id) ? client_id : 'Не указано';
}

function module_cart_add_to_cart (product_id, user_id) {
	if (window.XMLHttpRequest) { 
		req = new XMLHttpRequest(); 
	} else if (window.ActiveXObject) { 
		req = new ActiveXObject("Microsoft.XMLHTTP"); 
	}
	
	var user_id = getGoogleCID();
	if (req) {
		var cart_box = document.getElementById('m_cart_box');	    
	    var inputs = document.getElementsByTagName('input');
	    var values_radio = values_checkbox = values_quantity = '';
	    for (var i = 0; i < inputs.length; i++) {
			if (inputs[i].type === 'radio' && inputs[i].checked) { values_radio += inputs[i].value + ':'; }
			if (inputs[i].type === 'checkbox' && inputs[i].value !== "" && inputs[i].checked) { 
				values_checkbox += inputs[i].value + ':';
				if (inputs[i+1]!=undefined) {
					if (inputs[i+1].type === 'text') {
						values_quantity += inputs[i+1].value + ':';
					}
				}
			}
	    }
		var params = 'product_id=' + product_id + '&user_id=' + user_id + '&values_radio=' + values_radio + '&values_checkbox=' + values_checkbox + '&values_quantity=' + values_quantity + '&mode=addproduct'; 
		var url = "/modules/cart/m_ajax.php"; 
		req.onreadystatechange = function() {
			if (req.readyState == 4) { 
				if(req.status == 200) {
				    location.href = '/cart/';
				}
			}
		}
	}
	req.open("POST", url, true); 
	req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); 
	req.setRequestHeader('Content-length', params.length); 
	req.send(params);
}

/**
 * This funciton work with short button
 */
function module_cart_add_to_cart_short(button, product_name) {
	if (button == 'one') {
		show_callback_form(button);
		yaCounter24833000.reachGoal('buy1click');
	} else if (button == 'want') {
		show_callback_form(button);
		yaCounter24833000.reachGoal('buycheaper');
	} else if (button == 'product') {
		$("#custom_name_product").val(product_name);
		show_callback_form(button);
	} else {
		return false;
	}
}

/**
 * Delete product from cart
 */
function module_cart_delete_from_cart (product_uniq, user_id) {
	if (window.XMLHttpRequest) { 
		req = new XMLHttpRequest(); 
  } else if (window.ActiveXObject) { 
		req = new ActiveXObject("Microsoft.XMLHTTP"); 
  } 
	
	var user_id = getGoogleCID();
	
  if (req) {
 		var module_cart_items = document.getElementById('module_cart_order');
  	var params = 'product_uniq=' + product_uniq + '&user_id=' + user_id + '&mode=deleteproduct'; 
  	var url = "/modules/cart/m_ajax.php"; 
  	req.onreadystatechange = function() {
			if (req.readyState == 4) { 
				if(req.status == 200) {
					location.reload();
				}
			}
		}
	}	
  req.open("POST", url, true); 
  req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); 
  req.setRequestHeader('Content-length', params.length); 
  req.send(params);
}

/**
 * Count product cart
 */
function module_cart_count_action (product_id, user_id, mode) {
  if (window.XMLHttpRequest) { 
  	req = new XMLHttpRequest(); 
  } else if (window.ActiveXObject) { 
  	req = new ActiveXObject("Microsoft.XMLHTTP"); 
  } 
  
  var user_id = getGoogleCID();
  
  if (req) {
    if (mode == 'increase') {
        var params = 'product_id=' + product_id + '&user_id=' + user_id + '&mode=increase';
    } else if (mode == 'decrease') {
        var params = 'product_id=' + product_id + '&user_id=' + user_id + '&mode=decrease';
    }
 		var product_count = document.getElementById('product_cont_' + product_id);
    var product_subtotal = document.getElementById('cart_subtotal_' + product_id);
    var cart_total = document.getElementById('cart_total');
  	var url = "/modules/cart/m_ajax.php"; 
  	req.onreadystatechange = function() {  
			if (req.readyState == 4) { 
				if(req.status == 200) {
				  temp_data = req.responseText.split('---');
					product_count.innerHTML = temp_data[0];
          product_subtotal.innerHTML = temp_data[1];
          cart_total.innerHTML = temp_data[2];
          $('#module_cart_footer').fadeOut('slow');
          setTimeout("$('#module_cart_footer_temp').fadeIn('slow');", 500);
				}
			}
		}
	}
  req.open("POST", url, true); 
  req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); 
  req.setRequestHeader('Content-length', params.length); 
  req.send(params);
}

function module_cart_choice_order_method(item) {
    if (item == 'personal') {
        document.getElementById('module_cart_order_company').style.display = 'none';
        document.getElementById('module_cart_order_email').innerHTML = '';
    } else if (item == 'company') {
        document.getElementById('module_cart_order_company').style.display = 'block';
        document.getElementById('module_cart_order_email').innerHTML = '*';
    }
}

/**
 * This function run when order submit
 */
function module_cart_submit_order(user_id) {
	if (window.XMLHttpRequest) {
	  req = new XMLHttpRequest(); 
	} else if (window.ActiveXObject) { 
	  req = new ActiveXObject("Microsoft.XMLHTTP"); 
	}
	
	var user_id = getGoogleCID();
	
	if (req) {
		var order_status = document.getElementById('module_cart_order');
		var inputs = document.getElementsByTagName('input');
		var delivery_type = client_info = '';
		var delivery_date = document.getElementById('delivery_date').value;
		var region_km = document.getElementById('region_km').value;
		var delivery_price = document.getElementById('delivery_price').innerHTML;
		var delivery_price_clean = delivery_price.replace(" руб","");
		var client_direction = document.getElementById('cart_direction').value;
		var client_adress = document.getElementById('cart_adress').value;
		var client_name = document.getElementById('cart_name').value;
		var client_phone = document.getElementById('cart_phone').value;
		var client_additional = document.getElementById('cart_additional').value;
		var client_additional_clean = client_additional.replace("|","");
		var client_info = '{' + client_name + '|' + client_phone + '|' + client_adress + '|' + client_direction + '|' + client_additional_clean + '}';
		if (region_km == '') { 
			region_km = 0;
		} else {
			region_km = +region_km;
		}
    	for (var i = 0; i < inputs.length; i++) {
      		if (inputs[i].type === 'radio' && inputs[i].checked) {
				delivery_type = inputs[i].value
				if (delivery_type === 'region') {
					delivery_type = 'region|' + $('#shoce option:selected').val();
				}
			}
		}
	  var params = 'user_id=' + user_id + '&delivery_type=' + delivery_type + '&client_info=' + client_info + '&region_km=' + region_km + '&mode=submit_order&delivery_date=' + delivery_date + '&delivery_price=' + delivery_price_clean;
	  var url = "/modules/cart/m_ajax.php";
	  req.onreadystatechange = function() {
			if (req.readyState == 4) { 
				if(req.status == 200) {
					document.location.href = '/order/';
				} else {
					document.location.href = '/order_failed/';
				}
			}
		}
	}
	req.open("POST", url, true); 
	req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); 
	req.setRequestHeader('Content-length', params.length); 
	req.send(params);
}